<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>fast-watermark ä½¿ç”¨ç¤ºä¾‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section-title {
      color: #444;
      margin-bottom: 15px;
      font-size: 20px;
      font-weight: 600;
    }

    .upload-area {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f9f9f9;
    }

    .upload-area:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .upload-area.dragover {
      border-color: #667eea;
      background: #e8f0ff;
    }

    .upload-icon {
      font-size: 48px;
      color: #667eea;
      margin-bottom: 10px;
    }

    .upload-text {
      color: #666;
      font-size: 16px;
    }

    input[type="file"] {
      display: none;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .control-group {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
    }

    .control-group label {
      display: block;
      color: #555;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .control-group input,
    .control-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .control-group input:focus,
    .control-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .control-group input[type="color"] {
      height: 40px;
      padding: 5px;
    }

    .control-group input[type="range"] {
      padding: 5px 0;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .preview-area {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .preview-box {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
    }

    .preview-box h3 {
      color: #444;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .preview-box img {
      width: 100%;
      height: auto;
      border-radius: 6px;
      display: block;
    }

    .preview-box .placeholder {
      color: #999;
      text-align: center;
      padding: 40px;
      font-size: 14px;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      display: none;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      display: block;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }

    .result-info {
      margin: 20px 0;
      padding: 15px;
      background: #e8f5e9;
      border-radius: 8px;
      border: 1px solid #c8e6c9;
      display: none;
    }

    .result-info h3 {
      margin: 0 0 10px 0;
      color: #2e7d32;
      font-size: 16px;
    }

    .result-info p {
      margin: 5px 0;
      color: #388e3c;
    }

    .result-info span {
      font-weight: bold;
      font-size: 18px;
    }

    .result-info .detail {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #c8e6c9;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      font-weight: 500;
      color: #666;
      transition: all 0.3s;
    }

    .tab:hover {
      color: #667eea;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¨ fast-watermark ä½¿ç”¨ç¤ºä¾‹</h1>
    <p class="subtitle">åŸºäº Rust + WebAssembly çš„é«˜æ€§èƒ½å›¾ç‰‡æ°´å°åº“</p>

    <!-- ä¸Šä¼ åŒºåŸŸ -->
    <div class="section">
      <h2 class="section-title">1. ä¸Šä¼ å›¾ç‰‡</h2>
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">ğŸ“</div>
        <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
        <input type="file" id="fileInput" accept="image/*">
      </div>
    </div>

    <!-- æ°´å°é…ç½® -->
    <div class="section">
      <h2 class="section-title">2. é…ç½®æ°´å°</h2>
      
      <div class="tabs">
        <div class="tab active" data-tab="text">æ–‡å­—æ°´å°</div>
        <div class="tab" data-tab="image">å›¾ç‰‡æ°´å°</div>
      </div>

      <!-- æ–‡å­—æ°´å°é…ç½® -->
      <div class="tab-content active" id="textConfig">
        <div class="controls">
          <div class="control-group">
            <label>æ°´å°æ–‡å­—</label>
            <input type="text" id="watermarkText" value="Â© 2024 fast-watermark">
          </div>
          <div class="control-group">
            <label>å­—ä½“å¤§å°</label>
            <input type="number" id="fontSize" value="30" min="10" max="100">
          </div>
          <div class="control-group">
            <label>å­—ä½“é¢œè‰²</label>
            <input type="color" id="fontColor" value="#FFFFFF">
          </div>
          <div class="control-group">
            <label>ä¸é€æ˜åº¦</label>
            <input type="range" id="transparency" value="0.5" min="0" max="1" step="0.1">
          </div>
          <div class="control-group">
            <label>æ—‹è½¬è§’åº¦</label>
            <input type="range" id="rotate" value="0" min="-360" max="360">
          </div>
          <div class="control-group">
            <label>X è½´åç§»</label>
            <input type="number" id="xOffset" value="10">
          </div>
          <div class="control-group">
            <label>Y è½´åç§»</label>
            <input type="number" id="yOffset" value="10">
          </div>
          <div class="control-group">
            <label>å¹³é“ºæ¨¡å¼</label>
            <div class="checkbox-group">
              <input type="checkbox" id="tile">
              <span>å¯ç”¨å¹³é“º</span>
            </div>
          </div>
        </div>
      </div>

      <!-- å›¾ç‰‡æ°´å°é…ç½® -->
      <div class="tab-content" id="imageConfig">
        <div class="controls">
          <div class="control-group">
            <label>ä¸Šä¼ æ°´å°å›¾ç‰‡</label>
            <div class="upload-area" id="watermarkUploadArea" style="padding: 20px;">
              <div class="upload-icon">ğŸ–¼ï¸</div>
              <div class="upload-text">ç‚¹å‡»ä¸Šä¼ æ°´å°å›¾ç‰‡</div>
              <input type="file" id="watermarkFileInput" accept="image/*">
            </div>
          </div>
          <div class="control-group">
            <label>å®½åº¦</label>
            <input type="number" id="watermarkWidth" value="100" min="10" max="500">
          </div>
          <div class="control-group">
            <label>é«˜åº¦</label>
            <input type="number" id="watermarkHeight" value="100" min="10" max="500">
          </div>
          <div class="control-group">
            <label>ä¸é€æ˜åº¦</label>
            <input type="range" id="imageTransparency" value="0.5" min="0" max="1" step="0.1">
          </div>
          <div class="control-group">
            <label>æ—‹è½¬è§’åº¦</label>
            <input type="range" id="imageRotate" value="0" min="-360" max="360">
          </div>
          <div class="control-group">
            <label>X è½´åç§»</label>
            <input type="number" id="imageXOffset" value="10">
          </div>
          <div class="control-group">
            <label>Y è½´åç§»</label>
            <input type="number" id="imageYOffset" value="10">
          </div>
          <div class="control-group">
            <label>å¹³é“ºæ¨¡å¼</label>
            <div class="checkbox-group">
              <input type="checkbox" id="imageTile">
              <span>å¯ç”¨å¹³é“º</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="section">
      <div class="control-group" style="margin-bottom: 15px;">
        <label>å¤„ç†æ¨¡å¼</label>
        <div class="checkbox-group">
          <input type="checkbox" id="useAsync" checked>
          <span>ä½¿ç”¨å¼‚æ­¥æ–¹æ³•ï¼ˆæ¨èï¼Œé€‚åˆå¤§æ–‡ä»¶ï¼‰</span>
        </div>
      </div>
      <button class="btn btn-primary" id="addWatermarkBtn" disabled>
        <span>âœ¨ æ·»åŠ æ°´å°</span>
      </button>
      <button class="btn btn-secondary" id="downloadBtn" disabled>
        <span>ğŸ’¾ ä¸‹è½½å›¾ç‰‡</span>
      </button>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div>æ­£åœ¨å¤„ç†å›¾ç‰‡...</div>
    </div>

    <!-- çŠ¶æ€ä¿¡æ¯ -->
    <div class="status" id="status"></div>

    <!-- è€—æ—¶ç»Ÿè®¡ -->
    <div class="result-info" id="resultInfo">
      <h3>âš¡ å¤„ç†ç»“æœ</h3>
      <p>æ€»è€—æ—¶ï¼š<span id="elapsedTime">0</span> æ¯«ç§’</p>
      <p>å›¾ç‰‡å¤§å°ï¼š<span id="imageSize">0</span> KB</p>
      <div class="detail" id="performanceDetail"></div>
    </div>

    <!-- é¢„è§ˆåŒºåŸŸ -->
    <div class="section">
      <h2 class="section-title">3. é¢„è§ˆç»“æœ</h2>
      <div class="preview-area">
        <div class="preview-box">
          <h3>åŸå§‹å›¾ç‰‡</h3>
          <div id="originalPreview" class="placeholder">è¯·å…ˆä¸Šä¼ å›¾ç‰‡</div>
        </div>
        <div class="preview-box">
          <h3>æ°´å°åå›¾ç‰‡</h3>
          <div id="watermarkedPreview" class="placeholder">ç‚¹å‡»"æ·»åŠ æ°´å°"æŒ‰é’®</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      addWatermark,
      addWatermarkAsync,
      createTextWatermarkConfig,
      createImageWatermarkConfig,
      isImageFile
    } from './index.js';

    // DOM å…ƒç´ 
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const watermarkUploadArea = document.getElementById('watermarkUploadArea');
    const watermarkFileInput = document.getElementById('watermarkFileInput');
    const addWatermarkBtn = document.getElementById('addWatermarkBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const loading = document.getElementById('loading');
    const status = document.getElementById('status');
    const originalPreview = document.getElementById('originalPreview');
    const watermarkedPreview = document.getElementById('watermarkedPreview');

    // çŠ¶æ€
    let originalFile = null;
    let watermarkFile = null;
    let watermarkedBlob = null;
    let currentTab = 'text';
    let useAsync = false; // é»˜è®¤ä½¿ç”¨å¼‚æ­¥æ–¹æ³•

    // Tab åˆ‡æ¢
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}Config`).classList.add('active');
        currentTab = tab.dataset.tab;
      });
    });

    // æ–‡ä»¶ä¸Šä¼ å¤„ç†
    function handleFileUpload(file, isWatermark = false) {
      if (!isImageFile(file)) {
        showStatus('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶', 'error');
        return;
      }

      if (isWatermark) {
        watermarkFile = file;
        showStatus('æ°´å°å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
      } else {
        originalFile = file;
        addWatermarkBtn.disabled = false;
        showStatus('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
        
        // æ˜¾ç¤ºåŸå§‹å›¾ç‰‡é¢„è§ˆ
        const reader = new FileReader();
        reader.onload = (e) => {
          originalPreview.innerHTML = `<img src="${e.target.result}" alt="åŸå§‹å›¾ç‰‡">`;
        };
        reader.readAsDataURL(file);
      }
    }

    // ä¸Šä¼ åŒºåŸŸç‚¹å‡»
    uploadArea.addEventListener('click', () => fileInput.click());
    watermarkUploadArea.addEventListener('click', () => watermarkFileInput.click());

    // æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', (e) => {
      if (e.target.files[0]) {
        handleFileUpload(e.target.files[0]);
      }
    });

    watermarkFileInput.addEventListener('change', (e) => {
      if (e.target.files[0]) {
        handleFileUpload(e.target.files[0], true);
      }
    });

    // æ‹–æ‹½ä¸Šä¼ 
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      if (e.dataTransfer.files[0]) {
        handleFileUpload(e.dataTransfer.files[0]);
      }
    });

    // å¤„ç†æ¨¡å¼åˆ‡æ¢
    document.getElementById('useAsync').addEventListener('change', (e) => {
      useAsync = e.target.checked;
      const modeText = useAsync ? 'å¼‚æ­¥' : 'åŒæ­¥';
      console.log(`åˆ‡æ¢åˆ°${modeText}æ¨¡å¼`);
    });

    // æ·»åŠ æ°´å°
    addWatermarkBtn.addEventListener('click', async () => {
      if (!originalFile) {
        showStatus('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'error');
        return;
      }

      loading.classList.add('active');
      status.style.display = 'none';
      document.getElementById('resultInfo').style.display = 'none';

      try {
        let config;
        const startTime = performance.now();
        const modeText = useAsync ? 'å¼‚æ­¥' : 'åŒæ­¥';
        console.log(`å¼€å§‹æ·»åŠ æ°´å°ï¼ˆ${modeText}æ¨¡å¼ï¼‰ï¼Œæ—¶é—´æˆ³:`, startTime);

        if (currentTab === 'text') {
          // æ–‡å­—æ°´å°é…ç½®
          config = createTextWatermarkConfig({
            text: document.getElementById('watermarkText').value,
            fontSize: parseInt(document.getElementById('fontSize').value),
            fontColor: document.getElementById('fontColor').value,
            transparency: parseFloat(document.getElementById('transparency').value),
            rotate: parseInt(document.getElementById('rotate').value),
            xOffset: parseInt(document.getElementById('xOffset').value),
            yOffset: parseInt(document.getElementById('yOffset').value),
            tile: document.getElementById('tile').checked
          });
        } else {
          // å›¾ç‰‡æ°´å°é…ç½®
          if (!watermarkFile) {
            showStatus('è¯·å…ˆä¸Šä¼ æ°´å°å›¾ç‰‡', 'error');
            loading.classList.remove('active');
            return;
          }

          const watermarkBase64 = await fileToBase64(watermarkFile);
          config = createImageWatermarkConfig({
            imageData: watermarkBase64,
            width: parseInt(document.getElementById('watermarkWidth').value),
            height: parseInt(document.getElementById('watermarkHeight').value),
            transparency: parseFloat(document.getElementById('imageTransparency').value),
            rotate: parseInt(document.getElementById('imageRotate').value),
            xOffset: parseInt(document.getElementById('imageXOffset').value),
            yOffset: parseInt(document.getElementById('imageYOffset').value),
            tile: document.getElementById('imageTile').checked
          });
        }

        // æ·»åŠ æ°´å° - æ ¹æ®æ¨¡å¼é€‰æ‹©åŒæ­¥æˆ–å¼‚æ­¥æ–¹æ³•
        if (useAsync) {
          watermarkedBlob = await addWatermarkAsync(originalFile, config);
        } else {
          watermarkedBlob = await addWatermark(originalFile, config);
        }

        // è®°å½•ç»“æŸæ—¶é—´
        const endTime = performance.now();
        const elapsedTime = (endTime - startTime).toFixed(2);
        
        console.log('æ°´å°æ·»åŠ å®Œæˆï¼Œæ—¶é—´æˆ³:', endTime);
        console.log(`æ€»è€—æ—¶: ${elapsedTime} æ¯«ç§’ï¼ˆ${modeText}æ¨¡å¼ï¼‰`);

        // æ˜¾ç¤ºç»“æœ
        const imageUrl = URL.createObjectURL(watermarkedBlob);
        watermarkedPreview.innerHTML = `<img src="${imageUrl}" alt="æ°´å°åå›¾ç‰‡">`;
        
        // æ˜¾ç¤ºè€—æ—¶ä¿¡æ¯
        document.getElementById('elapsedTime').textContent = elapsedTime;
        document.getElementById('imageSize').textContent = (watermarkedBlob.size / 1024).toFixed(2);
        
        // æ˜¾ç¤ºæ€§èƒ½è¯¦æƒ…
        const performanceDetail = document.getElementById('performanceDetail');
        performanceDetail.innerHTML = `
          <p>ğŸ“Š æ€§èƒ½è¯¦æƒ…ï¼š</p>
          <p>â€¢ å¤„ç†æ¨¡å¼ï¼š<strong>${modeText}</strong></p>
          <p>â€¢ å¼€å§‹æ—¶é—´ï¼š${startTime.toFixed(2)} ms</p>
          <p>â€¢ ç»“æŸæ—¶é—´ï¼š${endTime.toFixed(2)} ms</p>
          <p>â€¢ å¤„ç†é€Ÿåº¦ï¼š${(watermarkedBlob.size / 1024 / (elapsedTime / 1000)).toFixed(2)} KB/s</p>
          <p>ğŸ’¡ æç¤ºï¼š${useAsync ? 'å¼‚æ­¥æ¨¡å¼é€‚åˆå¤§æ–‡ä»¶ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹' : 'åŒæ­¥æ¨¡å¼é€‚åˆå°æ–‡ä»¶ï¼Œå¤„ç†æ›´å¿«'}</p>
        `;
        
        document.getElementById('resultInfo').style.display = 'block';
        downloadBtn.disabled = false;
        showStatus(`æ°´å°æ·»åŠ æˆåŠŸï¼ï¼ˆ${modeText}æ¨¡å¼ï¼‰`, 'success');
      } catch (error) {
        console.error('æ·»åŠ æ°´å°å¤±è´¥:', error);
        showStatus(`æ·»åŠ æ°´å°å¤±è´¥: ${error.message}`, 'error');
      } finally {
        loading.classList.remove('active');
      }
    });

    // ä¸‹è½½å›¾ç‰‡
    downloadBtn.addEventListener('click', () => {
      if (!watermarkedBlob) {
        showStatus('è¯·å…ˆæ·»åŠ æ°´å°', 'error');
        return;
      }

      const url = URL.createObjectURL(watermarkedBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'watermarked-image.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // è¾…åŠ©å‡½æ•°ï¼šæ–‡ä»¶è½¬base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
    function showStatus(message, type) {
      status.textContent = message;
      status.className = `status ${type}`;
    }
  </script>
</body>
</html>